<!DOCTYPE html>
<html lang="ko">
<head>
<link href='/fullcalendar/lib/main.css' rel='stylesheet' />
<script src='/fullcalendar/lib/main.js'></script>
<script>
moca.EFC_SCHEDULER.calendar;
moca.EFC_SCHEDULER.___ready = function(){
	moca.EFC_SCHEDULER.fn_search();
};


moca.EFC_SCHEDULER.fn_search = function(_callbackJson){
	var _showMonth = moca.dateToString(new Date()).월;
	if(_callbackJson != null){
		_showMonth = moca.dateToString(new Date(_callbackJson.startDt)).월
	}
    moca.EFC_SCHEDULER.exe({
        url : moca._domain+moca._contextRoot+"/EFC_SCHEDULER/selectScheduleList.do",
        loadingbar:true,
        data : {
            "header" : moca.header,
            "body" : {
            	"SCH_CURRENTMONTH":_showMonth
            }
        },          
        callback : function(response){
        	moca.EFC_SCHEDULER.fn_setSchedule(response,_callbackJson);
        }
    });
	
};

moca.EFC_SCHEDULER.fn_setSchedule = function(response,_callbackJson){
	['캘린더세팅']
	var _defaultView = 'dayGridMonth';
	var _defaultDate;
	if(_callbackJson != null){
		_defaultView = _callbackJson.viewType;
		_defaultDate = _callbackJson.startDt;
	}
	var _schOriArray = response.selectScheduleList;
	var _schArray = [];
	for(var i=0; i<_schOriArray.length; i++){
		_schArray[i] = {
				'title':_schOriArray[i].SCH_TITLE,
				'start':_schOriArray[i].SCH_START,
				'end':_schOriArray[i].SCH_END,
				'display':_schOriArray[i].SCH_DISP,
				'color':_schOriArray[i].SCH_COLOR,
				'groupId':_schOriArray[i].SCH_IDX,
		}
	}
	var calendarEl = moca.EFC_SCHEDULER.getObj('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
    	headerToolbar: {
            left: 'prevBtn,nextBtn todayBtn',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        customButtons : {
        	prevBtn:{
        		text:'<',
        		click: function(info){
        			moca.EFC_SCHEDULER.calendar.prev();
        			var _startDt = moca.EFC_SCHEDULER.calendar.getDate();
        			var _callbackJson = {"startDt":_startDt,"viewType":moca.EFC_SCHEDULER.calendar.currentData.currentViewType};
        			moca.EFC_SCHEDULER.fn_search(_callbackJson);
        		}
        	},
        	nextBtn:{
        		text:'>',
        		click: function(info){
        			moca.EFC_SCHEDULER.calendar.next();
        			var _startDt = moca.EFC_SCHEDULER.calendar.getDate();
        			var _callbackJson = {"startDt":_startDt,"viewType":moca.EFC_SCHEDULER.calendar.currentData.currentViewType};
        			moca.EFC_SCHEDULER.fn_search(_callbackJson);
        		}
        	},
        	todayBtn:{
        		text:'오늘',
        		click: function(info){
        			moca.EFC_SCHEDULER.calendar.today();
        			var _startDt = moca.EFC_SCHEDULER.calendar.getDate();
        			var _callbackJson = {"startDt":_startDt,"viewType":moca.EFC_SCHEDULER.calendar.currentData.currentViewType};
        			moca.EFC_SCHEDULER.fn_search(_callbackJson);
        		}
        	}
        },
        columnFormat : {
        	month:'ddd',
        	week: 'M/d ddd',
        	day : 'M월d일 dddd'
        },
        titleFormat : function(date) { // title 설정
        	return date.date.year +"년 "+(date.date.month +1)+"월"; 
        },
        timeZone: 'local',
        dayHeaderContent: function (date) {
        	let weekList = ["일", "월", "화", "수", "목", "금", "토"];
        	if(date.view.type == 'timeGridWeek'){
        		var _dateObj = moca.dateToString(date.date);
        		var _dateStr = _dateObj.월+"/"+_dateObj.일;
        		for(var i=0; i < weekList.length ; i++ ){
        			weekList[i] = _dateStr+" "+ weekList[i]
        		}
        	}else if(date.view.type == 'timeGridDay'){
        		var _dateObj = moca.dateToString(date.date);
        		var _dateStr = _dateObj.월+"/"+_dateObj.일;
        		for(var i=0; i < weekList.length ; i++ ){
        			weekList[i] = _dateStr+" "+ weekList[i];
        		}
        	}
       	  return weekList[date.dow];
       	},
       	buttonText: {
            month: '월',
            week: '주',
            day: '일'
        },
        dayMaxEvents: true,
        moreLinkText: '개 추가일정',
        viewHint: '$0',
        expandRows: true, // 화면에 맞게 높이 재설정
        initialDate:_defaultDate,
      	initialView: _defaultView,
      	selectable: true,
      	select: function(info){
      		moca.EFC_SCHEDULER.fn_addSchedule(info,'C');
      	},
      	events: _schArray,
      	eventClick:function(info) {
      		moca.EFC_SCHEDULER.fn_addSchedule(info,'R');
        },
        longPressDelay:10
    });
    calendar.render();
    moca.EFC_SCHEDULER.calendar = calendar;
   
}

moca.EFC_SCHEDULER.popId = "EFC_SCHEDULER_POP";
moca.EFC_SCHEDULER.fn_addSchedule = function(_valueObj,_status){
	['일정등록 팝업']
	var _title = '';
	var _start = '';
	var _end = '';
	var _allday = '';
	var _schTitle = '';
	var _schIdx ='';
	var _bgcolor = '';
    if(_status == 'C'){
    	_title = '일정등록';
    	_start = moca.dateToString(_valueObj.start).fullFormat;
    	if(_valueObj.view.type == 'dayGridMonth'){
    		_end = moca.fullToMocaDT(moca.dateToString(_valueObj.end).fullFormat);
    	}else{
    		_end = moca.dateToString(_valueObj.end).fullFormat;
    	}
    }else{
    	_title = '일정상세';
    	var oriStartDate = _valueObj.event._instance.range.start;
    	var oriEndDate = _valueObj.event._instance.range.end;
    	var _startDate = new Date(oriStartDate.setHours(oriStartDate.getHours() - 9));
    	var _endDate = new Date(oriEndDate.setHours(oriEndDate.getHours() - 9));
    	
    	_start = moca.dateToString(_startDate).fullFormat;
    	_end = moca.dateToString(_endDate).fullFormat;
    	_schTitle = _valueObj.event._def.title;
    	_schIdx = _valueObj.event._def.groupId;
    	_bgcolor = _valueObj.event.backgroundColor;
    };
    
    
    var o = {};
    o.id = moca.EFC_SCHEDULER.popId;
    o.url = '/html/EFC/EFC_SCHEDULER_POP.html';
    o.type = "POPUP";
    o.modal = "true";
    o.title = _title;
    o.callback = moca.EFC_SCHEDULER.fn_pop_callback;
    o.scopeId = moca.EFC_SCHEDULER.pageId;
    o.data = {
 		'start' : _start,
 		'end'   : _end,
 		'allDay': false,
 		'title' : _schTitle,
 		'schIdx': _schIdx,
 		'viewType':_valueObj.view.type,
 		'bgcolor':_bgcolor
    }
    var _thisObj = moca.EFC_SCHEDULER.getObj('calendar');
    moca.popup(o,_thisObj);
}

moca.EFC_SCHEDULER.fn_pop_callback = function(_json){
	if(_json != null && _json.message){
		moca.alert(_json.message);
	}
	if(_json != null && _json.callback == 'true' && _json.viewType && _json.startDt){
		var _callbackJson = {};
		_callbackJson.viewType = _json.viewType;
		_callbackJson.startDt = _json.startDt;
		moca.EFC_SCHEDULER.fn_search(_callbackJson);
	}
}

</script>

</head>
<body>
<div id="moca_tab_bridge1" class="moca_tab_panel" role="mdipanel" style="display:block;visibility:visible;">
	<div class="moca_tab_cont" style="height:100%">
		<div class="moca_cont_wrap flex fcol">
			<div type="wframe" class="moca_titbox cm noshbox" id="titbox" tag="moca:titbox" 
				src="/html/titlebox.html"
				data = '{"sreenCd":"MOCA_SCHEDULER","sreenNm":"스케줄러","sreenPath":"업무관리,스케줄러"}'
			></div>
			<div class="fullcalendar" id='calendar' style="display:flex; height:100%"></div>
			
		</div>
	</div>
</div>
	
</body>
</html>
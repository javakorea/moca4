<!DOCTYPE html>
<html lang="ko">
<head meta_width="807px" meta_height="350px">
<script>
$m.RM_CONTRACT_POP.___ready = function(args){
	
	if(args != null){
		$m.RM_CONTRACT_POP.args = args;
		$m.RM_CONTRACT_POP.CONTRACT_NUM = $m.RM_CONTRACT_POP.args.parent.data.CONTRACT_NUM;
		$m.RM_CONTRACT_POP.fn_search();
	}else{
		$m.RM_CONTRACT_POP.fn_comboSearch();
	}
	
	
};

$m.RM_CONTRACT_POP.fn_comboSearch = function(_pageNum){
	$m.RM_CONTRACT_POP.exe({
		url : $m._domain+$m._contextRoot+"/RM_BUILDING/selectBuildingList.do",
        data : {
        	"header" : $m.header,
        	"body" : {
        		"SELECT_TYPE":"combo"
        	}
        },			
		callback : function(response){
			$m.RM_CONTRACT_POP.bindCombo("cmb_1", {
	            metaInfo : {
	                codeCd : "BUILDING_NUM",
	                codeNm : "BUILDING_NAME"
	            }
	        }, response.selectBuildingComboList);
			$m.RM_CONTRACT_POP.fn_roomComboSearch();
		}
	});
};
$m.RM_CONTRACT_POP.fn_roomComboSearch = function(_buildingNum){
	$m.RM_CONTRACT_POP.exe({
		url : $m._domain+$m._contextRoot+"/RM_ROOM/selectRoomList.do",
        data : {
        	"header" : $m.header,
        	"body" : {
        		"SELECT_TYPE":"combo",
        		"BUILDING_NUM":$m.RM_CONTRACT_POP.getCombo("cmb_1")
        	}
        },			
		callback : function(response){
			$m.RM_CONTRACT_POP.bindCombo("cmb_2", {
	            metaInfo : {
	                codeCd : "ROOM_NUM",
	                codeNm : "ROOM_NUM"
	            }
	        }, response.selectRoomComboList);
			
		}
	});
	
};
$m.RM_CONTRACT_POP.data;
$m.RM_CONTRACT_POP.fn_search = function(_grd,_idx,tdObj,_thisObj){
	$m.RM_CONTRACT_POP.exe({
		url : $m._domain+$m._contextRoot+"/RM_CONTRACT/selectContractInfo.do",
        data : {
        	"header" : $m.header,
        	"body" : {
        		"CONTRACT_NUM":$m.RM_CONTRACT_POP.CONTRACT_NUM
        	}
        },			
		callback : function(response){
			if(response.selectContractInfo != null ){
				var data = response.selectContractInfo;
				$m.RM_CONTRACT_POP.data = data;

				
				//$m.setReadOnly($m.RM_CONTRACT_POP.getObj("cmb_1"),true);
				//$m.setReadOnly($m.RM_CONTRACT_POP.getObj("cmb_2"),true);
				$m.setReadOnly($m.RM_CONTRACT_POP.getObj("ipt_LANDLORD_NAME"),true);
				$m.setReadOnly($m.RM_CONTRACT_POP.getObj("ipt_TENANT_NAME"),true);
				$m.setReadOnly($m.RM_CONTRACT_POP.getObj("ipt_DEPOSIT"),true);
				$m.setReadOnly($m.RM_CONTRACT_POP.getObj("ipt_MONTLY_RENT"),true);
				$m.setReadOnly($m.RM_CONTRACT_POP.getObj("ipt_MANAGEMENT_FEE"),true);
				$m.setReadOnly($m.RM_CONTRACT_POP.getObj("ica_CONTRACT_DATE"),true);
				
				
				$m.setValue($m.RM_CONTRACT_POP.getObj("ipt_LANDLORD_NAME"),data.LANDLORD_NAME);
				$m.setValue($m.RM_CONTRACT_POP.getObj("ipt_TENANT_NAME"),data.TENANT_NAME);
				$m.setValue($m.RM_CONTRACT_POP.getObj("ipt_DEPOSIT"),data.DEPOSIT);
				$m.setValue($m.RM_CONTRACT_POP.getObj("ipt_MONTLY_RENT"),data.MONTLY_RENT);
				$m.setValue($m.RM_CONTRACT_POP.getObj("ipt_MANAGEMENT_FEE"),data.MANAGEMENT_FEE);
				$m.RM_CONTRACT_POP.setFrom('ica_CONTRACT_DATE',data.RENT_START);
		        $m.RM_CONTRACT_POP.setTo('ica_CONTRACT_DATE',data.RENT_END);
		        $m.setValue($m.RM_CONTRACT_POP.getObj("createDate"),data.WRITE_TIME);
		        $m.setValue($m.RM_CONTRACT_POP.getObj("wid"),data.WRITER);
		        
		        $m.RM_CONTRACT_POP.fn_comboSearch();
		        $m.setValue($m.RM_CONTRACT_POP.getObj("cmb_1"),data.BUILDING_NUM);
				$m.setValue($m.RM_CONTRACT_POP.getObj("cmb_2"),data.ROOM_NUM);
		        
			}
		}
	});
};
$m.RM_CONTRACT_POP.fn_update = function(_thisObj){

}
$m.RM_CONTRACT_POP.fn_save = function(_thisObj){
	
	if($m.RM_CONTRACT_POP.fn_validate("ipt_LANDLORD_NAME")){
		if($m.RM_CONTRACT_POP.fn_validate("ipt_TENANT_NAME")){
			$m.RM_CONTRACT_POP.exe({
				url : $m._domain+$m._contextRoot+"/RM_CONTRACT/insertContract.do",
		        data : {
		        	"header" : $m.header,
		        	"body" : {
		        		"BUILDING_NUM":$m.RM_CONTRACT_POP.getCombo("cmb_1"),
		        		"ROOM_NUM":$m.RM_CONTRACT_POP.getCombo("cmb_2"),
		        		"TENANT_NAME":$m.getValue($m.RM_CONTRACT_POP.getObj( "ipt_TENANT_NAME")),
		        		"LANDLORD_NAME":$m.getValue($m.RM_CONTRACT_POP.getObj( "ipt_LANDLORD_NAME")),
		        		"DEPOSIT":$m.getValue($m.RM_CONTRACT_POP.getObj( "ipt_DEPOSIT")),
		        		"MONTLY_RENT":$m.getValue($m.RM_CONTRACT_POP.getObj( "ipt_MONTLY_RENT")),
		        		"MANAGEMENT_FEE":$m.getValue($m.RM_CONTRACT_POP.getObj( "ipt_MANAGEMENT_FEE")),
		        		"RENT_START":$m.RM_CONTRACT_POP.getFrom('ica_CONTRACT_DATE'),
		        		"RENT_END":$m.RM_CONTRACT_POP.getTo('ica_CONTRACT_DATE'),
		        		"CONTRACT_FILE":"0",
		        		"WRITER":$m.getSs("USER_ID")
		        		
		        	}
		        },			
				callback : function(response){
					if(response.cnt > 0){
		                 $m.popClose($m.RM_CONTRACT_POP.pageId,{callback:"true",message:"성공적으로 저장하였습니다."});
		             }
				}
			});
		}
	}
	
};
$m.RM_CONTRACT_POP.fn_del = function(_thisObj){

};
$m.RM_CONTRACT_POP.fn_validate = function(_thisObjStr){
	if($m.getValue($m.RM_CONTRACT_POP.getObj(_thisObjStr)) != ''){
		return true;
	}else{
		var _label;
		if(_thisObjStr == 'ipt_TENANT_NAME'){
			_label = '임차인';
		}else if(_thisObjStr == 'ipt_LANDLORD_NAME'){
			_label = '임대인';
		}
		$m.alert(_label+'을 입력해주세요');
		return false;
	}
}
$m.RM_CONTRACT_POP._openFileUpload = function(_thisObj) {
	 var o = {};
	 	o.url = '/moca/comp/COMP_UPLD.html';
	 	//o.id = "COMP_UPLD";
	    o.type = "POPUP";
	    o.modal = "false";
	    o.title = '파일업로드';
	    o.callback = function(result){
	    	if(result != null){
	    		//업로드완료후 리턴업로드된파일정보를 받아서
	            //이후 파일관련테이블에 insert하는 로직을 추가한다.
	            var fileSize = result.fileSize;
	            var fileLength = result.fileLength;
	            var originalFilename = result.originalFilename;
	            var physicalFilename = result.physicalFilename;
	            var physicalFilepath = result.physicalFilepath;
	            var subDir = result.subDir;
	            var uploadDir = result.uploadDir;
	            var arr = $m.RM_CONTRACT_POP.getObj("grd_file").list;
	            var row = {CONTFILE_NAME:originalFilename,CONTFILE_SIZE:fileSize,CONTFILE_NAMESERVER:physicalFilename,CONTFILE_PATH:physicalFilepath,CONTFILE_ID:result.id}; 
	            row._system = {"status":""};
	            var sn = arr.length;
	            arr[sn] =  row;
	            $m.RM_CONTRACT_POP.drawGrid('grd_file',arr);
	            
	            //grd_file.list[sn]._system.status = "C";
	    	}
       },
	    o.scopeId = $m.RM_CONTRACT_POP.pageId;
	    o.data = {
	    		subDir:"RM_CONTRACT_POP",
	            onFileSelected:"$m.RM_CONTRACT_POP.onFileSelected"
	    };
	    $m.popup(o,_thisObj);
};
$m.RM_CONTRACT_POP.grd_fileDownload = function(_grd,rowIndex,colIndex,colId){
	$m.RM_CONTRACT_POP.grd_fileDownload_google(_grd,rowIndex,colIndex,colId);
};


$m.RM_CONTRACT_POP.grd_fileDownload_google = async function(_grd,rowIndex,colIndex,colId){
	var _list = $m.RM_CONTRACT_POP.getObj('grd_file').list;
	var id = _list[rowIndex].CONTFILE_ID;
      try {
      	  await gapi.client.load('drive','v3');
	      const request = gapi.client.drive.files.get({
		      fileId: id,
		      fields: 'webContentLink,id,name'
	      });
		  //console.log("--->",request);
	      request.execute(function (resp) {
	    	  //console.log("2--->",resp);
		      if (resp.webContentLink) {
		      	window.location.assign(resp.webContentLink);
		      } else {
		      	var formattedJson = JSON.stringify(resp.result, null, 2);
		      }
	      });

      } catch (e) {
      	console.log('Error getting files', e);
      }
    
};

$m.RM_CONTRACT_POP.onFileSelected = function(filename,filesize,_e,_this) {
    //filename이나 filesize를 활용하여 업로드여부를 체크할수있다.
    
    return true;//or false
};
</script>
<style>
</style>
</head>
<body>
	<div class="moca_pop_cont_wrap flex mobile" style="min-width:unset" id="contents">
        <div class="lybox flex fauto">
            <div class="ly_column col_5 fauto">
                <div class="ly_col_cont flex fcol">
			         <div type="form" id="form_schedule" class="moca_table toolbar" style=""
							label=""
							showRowSelection="false"
							addition='[
								{"type":"button","position":"right","id":"btn_save","label":"저장","onclick":"$m.RM_CONTRACT_POP.fn_save","innerStyle":"background:#97a2ba"},
								{"type":"button","position":"right","id":"btn_update","label":"수정","onclick":"$m.RM_CONTRACT_POP.fn_update","innerStyle":"background:#97a2ba"},
								{"type":"button","position":"right","id":"btn_del","label":"삭제","onclick":"$m.RM_CONTRACT_POP.fn_del","innerStyle":"background:#6d7993"}
							]'
					 >
						
						
						<div class="moca_table_cont" type="table">
							<div type="tbody">
								<div type="tr">
									<div type="th">건물명</div>
									<div type="td">
										<div type="combo" 
											id="cmb_1" 
											class="moca_combo req"
											innerOnchange="$m.RM_CONTRACT_POP.fn_roomComboSearch(this)"
											style="width:163px" 
											displayFormat="[label]" 
											cdField="BUILDING_NUM" 
											nmField="BUILDING_NAME"
										>
										</div>
									</div>
								</div> 
								
								<div type="tr">
									<div type="th">방번호</div>
									<div type="td">
										<div type="combo" 
											id="cmb_2" 
											class="moca_combo req" 
											style="width:163px" 
											displayFormat="[label]" 
											cdField="ROOM_NUM" 
											nmField="ROOM_NUM"
										>
										</div>
									</div>
								</div>
								<div type="tr">
									<div type="th">임대인</div>
									<div type="td">
										<div type="input" id="ipt_LANDLORD_NAME" class="mocaInput fl req" innerClass="" onclick="" style="" value="" readonly="false"></div>
									</div>
								</div>
								<div type="tr">
									<div type="th">임차인</div>
									<div type="td">
										<div type="input" id="ipt_TENANT_NAME" class="mocaInput fl req" innerClass="" onclick="" style="" value="" readonly="false"></div>
									</div>
								</div> 
								<div type="tr">
									<div type="th">보증금 (만원)</div>
									<div type="td">
										<div type="input" id="ipt_DEPOSIT" class="mocaInput fl" innerClass="tar" onclick="" style="" displayFunction="$m.comma" value="0" readonly="false"></div>
									</div>
								</div>
								<div type="tr">
									<div type="th">월세 (만원)</div>
									<div type="td">
										<div type="input" id="ipt_MONTLY_RENT" class="mocaInput fl" innerClass=" tar" onclick="" style="" displayFunction="$m.comma" value="0" readonly="false"></div>
									</div>
								</div>
								<div type="tr">
									<div type="th">관리비 (만원)</div>
									<div type="td">
										<div type="input" id="ipt_MANAGEMENT_FEE" class="mocaInput fl" innerClass="tar" onclick="" style="" displayFunction="$m.comma" value="0" readonly="false"></div>
									</div>
								</div> 
								<div type="tr">
									<div type="th">계약기간</div>
									<div type="td">
										 <div type="inputMultiCalendar" class="moca_ica fl" style="width:calc(100% - 2px)" id="ica_CONTRACT_DATE" displayFormat="####-##-## ##:##" 
											   defaultValue="12개월전" 
											   selecterItem="오늘,3일전,6일전"
											   showRadioOption="false"
											   maxTermByDay="365"
										 ></div>
									</div>
								</div>
								<div type="tr">
									<div type="th">작성일시</div>
									<div type="td">
										<div type="input" id="createDate" class="mocaInput" innerClass="" onclick="" style="" value="" readonly="true" displayFunction="$m.longToDate"></div>
									</div>
								</div>
								<div type="tr">
									<div type="th">작성자명</div>
									<div type="td">
										<div type="input" id="wid" class="mocaInput" innerClass="" onclick="" style="" value="" readonly="true"></div>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<div type="grid" class="moca_grid toolbar sc_row1 mt10" default_cell_height="26px" id="grd_file" style=" top:0; height:112px" rowSelectedColor="#434e5f"
			        
			                            toolbar_search_size="false"
			                            toolbar_detail="false"
			                            toolbar_exup="false"
			                            toolbar_exdn="false"
			                            toolbar_addrow="false"
			                            toolbar_delrow="true"
			                            toolbar_nextbtn="false"
			                            toolbar_full="false"
			                            toolbar_fold="true"
			                            onFoldClick="$m.RM_CONTRACT_POP.grd_btnShowHide"
			                            toolbar_grid_button2='{"position":"left","id":"btn_add","label":"파일찾기","onclick":"$m.RM_CONTRACT_POP._openFileUpload","addClass":"","innerDisabled":"false"}'
			                            onDblClick = "$m.RM_CONTRACT_POP.grd_fileDownload"
			                            onRowSelected="$m.RM_CONTRACT_POP.showFileURL"
			                            subLabel="첨부파일"
			        
			        >
			                <table style="width: 100%">
			                    <colgroup>
			                            <col style="width:50px" mobileHide="true" columnKey="status" thKey="H_status">
			                            <col style="width:50px">
			                            <col style="width:50px">
			                            <col style="">
			                            <col style="width:70px">       
			                    </colgroup>
			                    <thead>
			                        <tr>
			                            <th scope="col" id="H_status">상태</th>
			                            <th scope="col" id="H_CONTFILE_IDX">IDX</th>
			                            <th scope="col" id="H_CONTFILE_ID">ID</th>
			                            <th scope="col" id="H_CONTFILE_NAME">파일명</th>
			                            <th scope="col" id="H_CONTFILE_SIZE">파일크기</th>
			                        </tr>
			                    </thead>
			                    <tbody>
			                        <tr>
			                            <td id="status" celltype="input" style="" readOnly="true" name="상태"></td>
			                            <td id="CONTFILE_IDX" celltype="input" style="" readOnly="true" name="IDX"></td>
			                            <td id="CONTFILE_ID" celltype="input" style="" readOnly="true" name="파일ID"></td>
			                            <td id="CONTFILE_NAME" celltype="input" style="text-align:left" name="파일명" readOnly="true"></td>
			                            <td id="CONTFILE_SIZE" celltype="input" style="" name="파일크기" readOnly="true" displayFunction="$m.util.bytesToLabel"></td>
			                        </tr>
			                    </tbody>
			                </table>                
			        </div>
                </div>
            </div>
        </div>
	</div>
</body>
</html>
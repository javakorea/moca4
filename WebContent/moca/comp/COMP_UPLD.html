<!DOCTYPE html>
<html lang="ko">
<head meta_width="700px" meta_height="130px">
<script>
	$m.COMP_UPLD.___ready = function(args){
		var mfile = $m.COMP_UPLD.getObj("mfile");
		$(mfile).change(function(e){
			var onFileSelected = $m.COMP_UPLD.data.parent.data.onFileSelected;
			if(onFileSelected != null){
				var fid = this.id;
				var fobj = document.getElementById(""+fid).files[0];
				var re = eval(onFileSelected)(fobj.name,fobj.size,e,this);
				if(re){
					$($m.COMP_UPLD.getObj("btns")).show();
				}
			}
		});
		if(args != null){
			$m.COMP_UPLD.data = args;
			if(args.parent.data.mapper != null && Object.keys(args.parent.data.mapper).length < 1){
				$m.error('');
				return;
			}
		}
	};
	  

	$m.COMP_UPLD.fn_upload_prev = function(_uploadType){
		var mfile = $m.COMP_UPLD.getObj("mfile");
		if($m.trim($(mfile).val()) == ''){
			alert('업로드할 파일을 선택하세요.');
			return;
		}
		//$m.COMP_UPLD.fn_upload();
		$m.COMP_UPLD.fn_upload_google();
	};
	
	$m.COMP_UPLD.fn_upload = function(_uploadType){
		$m.COMP_UPLD.data.parent.data.uploadType = _uploadType;
		var _form = document.createElement('FORM');
		_form.setAttribute("encoding","multipart/form-data");
		_form.setAttribute("enctype","multipart/form-data");
		_form.setAttribute("accept-charset","UTF-8");
		document.body.appendChild(_form);
		var formData = new FormData(_form);
		formData.append("file", $("#mfile")[0].files[0]);
		formData.append("data", JSON.stringify($m.COMP_UPLD.data));
		var loadingId = $m.loading(null,null,$m.COMP_UPLD.data.parent,{loadingbar:true});
		$.ajax({
			url: $m._contextRoot+'/moca/fileUpload.do',
			processData: false,
			contentType: false,
			data: formData,
			type: 'POST',
			success: function(response){
				$m.loading(loadingId,0,$m.COMP_UPLD.data.parent);
				$m.popClose($m.COMP_UPLD.pageId,response.result);
			}
	    });
	};
	
	
	$m.COMP_UPLD.fn_upload_google = function(_uploadType){
		handleAuthClick(function(){
		  	var file = $("#mfile")[0].files[0];
		  	var metadata = {
		        'name': file.name, // Filename at Google Drive
		        'mimeType': file.type, // mimeType at Google Drive 
		        "parents": ["17zolc486M-P5IdrioullpMSxdybixHYc"]//images폴더
		        //"parents": ["1A08_6NmblCDcgx72lA1dIMsp9NZma8hA"]//board폴더
		  	
		  	};
		    var accessToken = gapi.auth.getToken().access_token; // Here gapi is used for retrieving the access token.
		    var form = new FormData();
		    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
		    form.append('file', file);
		    
		    var loadingId = $m.loading(null,null,$m.COMP_UPLD.data.parent,{loadingbar:true});
		    var xhr = new XMLHttpRequest();
		    xhr.open('post', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=*');
		    xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
		    xhr.responseType = 'json';
		    xhr.onload = () => {
		        console.log("================>",xhr.response); // Retrieve uploaded file ID.
		        $m.loading(loadingId,0,$m.COMP_UPLD.data.parent);
		        
		        /*
		        
		     '{"kind":"drive#file","id":"1z7kAi52ibEQFhaE96CmeDZMx2sGcrXUr","name":"dsss.png","mimeType":"image/png","starred":false,"trashed":false,"explicitlyTrashed":false,"parents":["17zolc486M-P5IdrioullpMSxdybixHYc"],"spaces":["drive"],"version":"1","webContentLink":"https://drive.google.com/uc?id=1z7kAi52ibEQFhaE96CmeDZMx2sGcrXUr&export=download","webViewLink":"https://drive.google.com/file/d/1z7kAi52ibEQFhaE96CmeDZMx2sGcrXUr/view?usp=drivesdk","iconLink":"https://drive-thirdparty.googleusercontent.com/16/type/image/png","hasThumbnail":true,"thumbnailLink":"https://lh6.googleusercontent.com/zOpGR5MWmoJoZGV9VkBEVyVx1L1dyTbkxcbTxgI5th1f83fyFp3e-MxWbBrqH4qNQxUcZNWYUjc_Hp4=s220","thumbnailVersion":"1","viewedByMe":false,"createdTime":"2022-10-06T02:39:18.806Z","modifiedTime":"2022-10-06T02:39:18.806Z","modifiedByMeTime":"2022-10-06T02:39:18.806Z","modifiedByMe":true,"owners":[{"kind":"drive#user","displayName":"김세창","photoLink":"https://lh3.googleusercontent.com/a/default-user=s64","me":true,"permissionId":"16756116585207586092","emailAddress":"javakoreaboss@gmail.com"}],"lastModifyingUser":{"kind":"drive#user","displayName":"김세창","photoLink":"https://lh3.googleusercontent.com/a/default-user=s64","me":true,"permissionId":"16756116585207586092","emailAddress":"javakoreaboss@gmail.com"},"shared":true,"ownedByMe":true,"capabilities":{"canAcceptOwnership":false,"canAddChildren":false,"canAddMyDriveParent":false,"canChangeCopyRequiresWriterPermission":true,"canChangeSecurityUpdateEnabled":false,"canChangeViewersCanCopyContent":true,"canComment":true,"canCopy":true,"canDelete":true,"canDownload":true,"canEdit":true,"canListChildren":false,"canModifyContent":true,"canModifyLabels":false,"canMoveChildrenWithinDrive":false,"canMoveItemIntoTeamDrive":true,"canMoveItemOutOfDrive":true,"canMoveItemWithinDrive":true,"canReadLabels":false,"canReadRevisions":true,"canRemoveChildren":false,"canRemoveMyDriveParent":true,"canRename":true,"canShare":true,"canTrash":true,"canUntrash":true},"viewersCanCopyContent":true,"copyRequiresWriterPermission":false,"writersCanShare":true,"permissions":[{"kind":"drive#permission","id":"anyoneWithLink","type":"anyone","role":"reader","allowFileDiscovery":false},{"kind":"drive#permission","id":"16756116585207586092","type":"user","emailAddress":"javakoreaboss@gmail.com","role":"owner","displayName":"김세창","photoLink":"https://lh3.googleusercontent.com/a/default-user=s64","deleted":false,"pendingOwner":false}],"permissionIds":["anyoneWithLink","16756116585207586092"],"originalFilename":"dsss.png","fullFileExtension":"png","fileExtension":"png","md5Checksum":"b02ddb7baa3acdfe4225e666bb3e9d27","sha1Checksum":"445abd60358b56de5488082f1be534a2b80e233c","sha256Checksum":"dffe6b2101a224ff737c71e9c0b874560e3a9cb9447f4315e11b7a60212506d4","size":"6714","quotaBytesUsed":"6714","headRevisionId":"0B12HOqB1X3cZZzUwblRzZ2UzSHZHOUJnS2c1Z0xYMC9xbGxjPQ","imageMediaMetadata":{"width":710,"height":599,"rotation":0},"isAppAuthorized":true,"linkShareMetadata":{"securityUpdateEligible":false,"securityUpdateEnabled":true}}'   
		        
		        
		        */
		     	if(xhr.response.error){
		     		alert(xhr.response.error.message);
		     		return;
		     	}
		        var result = {};
		        result.id = xhr.response.id;
		        result.fileSize = xhr.response.size;
	            result.fileLength = xhr.response.size;
	            result.originalFilename = xhr.response.name;
	            result.physicalFilename = xhr.response.id;
	            if(xhr.response.parents){
	            	result.physicalFilepath= xhr.response.parents[0];
	            }else{
	            	result.physicalFilepath= "memta:"+metadata.parents[0];
	            }
	            
	            result.subDir= 'board';
	            result.uploadDir= xhr.response.kind;
	            $m.popClose($m.COMP_UPLD.pageId,result);
	    		
		        //document.getElementById("testImg").setAttribute("src","https://drive.google.com/uc?id="+xhr.response.id);
		    };
		    xhr.upload.onprogress = function(e){
				var per = e.loaded * 100 / e.total;
				console.log("per",per);
			};
		    xhr.send(form);
		});
	};
	
</script>
</head>
<body>
	<div class="moca_pop_cont_wrap scroll" id="Pop_body">
		<div class="moca_shbox">
			<div class="shbox_inner pb10">
				<input type="file" multiple="multiple" title="파일 추가" id="mfile">
			</div>
			<div class="btn_shbox" id="btns" style='display:none'>
				<button type="button" class="button btn_sc" onclick="$m.COMP_UPLD.fn_upload_prev('1')"><i class="fas fa-plus"></i><span>업로드</span></button>
			</div>
		</div>
	</div>	
</body>
</html>
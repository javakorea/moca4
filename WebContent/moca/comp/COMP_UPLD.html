<!DOCTYPE html>
<html lang="ko">
<head meta_width="700px" meta_height="550px">
<script>
	$m.COMP_UPLD.___ready = function(args){
		var mfile = $m.COMP_UPLD.getObj("mfile");
		$(mfile).change(function(e){
			var onFileSelected = $m.COMP_UPLD.data.parent.data.onFileSelected;
			if(onFileSelected != null){
				var fid = this.id;
				var fobj = document.getElementById(""+fid).files[0];
				var re = eval(onFileSelected)(fobj.name,fobj.size,e,this);
				if(re){
					$m.COMP_UPLD.fn_upload_prev('1')
				}
				
			}
		});
		if(args != null){
			$m.COMP_UPLD.data = args;
			if(args.parent.data.mapper != null && Object.keys(args.parent.data.mapper).length < 1){
				$m.error('');
				return;
			}
		}
		$m.COMP_UPLD.circlePromgressinit();		
	};
	$m.COMP_UPLD.fn_upload_filedrop = async function(e){
		e.preventDefault();
		await $m.COMP_UPLD.fn_upload_google(e.dataTransfer.files);
	};
	$m.COMP_UPLD.fn_upload_filedropover = function(e){
		e.preventDefault();
	};	
	$m.COMP_UPLD.fn_upload_prev = function(_uploadType){
		var mfile = $m.COMP_UPLD.getObj("mfile");
		if($m.trim($(mfile).val()) == ''){
			alert('업로드할 파일을 선택하세요.');
			return;
		}
		$m.COMP_UPLD.fn_upload_google(mfile.files);
	};
	$m.COMP_UPLD.fn_upload = function(_uploadType){
		$m.COMP_UPLD.data.parent.data.uploadType = _uploadType;
		var _form = document.createElement('FORM');
		_form.setAttribute("encoding","multipart/form-data");
		_form.setAttribute("enctype","multipart/form-data");
		_form.setAttribute("accept-charset","UTF-8");
		document.body.appendChild(_form);
		var formData = new FormData(_form);
		formData.append("file", $("#mfile")[0].files[0]);
		formData.append("data", JSON.stringify($m.COMP_UPLD.data));
		$.ajax({
			url: $m._contextRoot+'/moca/fileUpload.do',
			processData: false,
			contentType: false,
			data: formData,
			type: 'POST',
			success: function(response){
				$m.popClose($m.COMP_UPLD.pageId,response.result);
			}
	    });
	};
	$m.COMP_UPLD.fn_upload_google = function(arr){
		handleAuthClick(async function(){
			return await $m.COMP_UPLD.fn_upload_google_proc(arr);
		});
	};
	$m.COMP_UPLD.fn_upload_google_proc = async function(arr){
			var arr_leng = arr.length;
			let j = 0;
			var promise = Promise.resolve();
			for(var i=0; i < arr_leng; i++){
				promise = promise.then(function(ret){
					var p2 = Promise.resolve();
					p2 = p2.then(async function(ret){
						$m.COMP_UPLD.circlePromgressinit();
						let file = arr[j++];
						file = await $m.resizeFile(file);
						return file;
					});
					p2 = p2.then(function(file){
						return new Promise(function(resolve, reject){
						  	var metadata = {'name': file.name,'mimeType': file.type,"parents": ["17zolc486M-P5IdrioullpMSxdybixHYc"]};
						    var accessToken = gapi.auth.getToken().access_token;
						    var form = new FormData();
						    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
						    form.append('file', file);
						    var xhr = new XMLHttpRequest();
						    xhr.open('post', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=*');
						    xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
						    xhr.responseType = 'json';
						    xhr.onload = () => {
						     	if(xhr.response.error){alert(xhr.response.error.message);reject();return;}
						        var result = {};
						        result.id = xhr.response.id;
						        result.fileSize = xhr.response.size;
					            result.fileLength = xhr.response.size;
					            result.originalFilename = xhr.response.name;
					            result.physicalFilename = xhr.response.id;
					            if(xhr.response.parents){
					            	result.physicalFilepath= xhr.response.parents[0];
					            }else{
					            	result.physicalFilepath= "memta:"+metadata.parents[0];
					            } 
					            result.subDir= 'board';
					            result.uploadDir= xhr.response.kind;
					            if($m.COMP_UPLD.resultArr == null){
					            	$m.COMP_UPLD.resultArr = [];
					            }
					            $m.COMP_UPLD.resultArr.push(result);
					            resolve();
						    };
						    xhr.upload.onprogress = function(e){
						    	$('#canvas').show();
						    	$('#white_dim_txt').show();
						    	$('.white_dim').show();
								var per = e.loaded * 100 / e.total;
								$m.COMP_UPLD.circleProgressBar.animateTo( per/100 , 0.5 );
								$('#white_dim_txt').html(j+"/"+arr_leng+"&nbsp;"+parseInt(per)+"%");
							};
						    xhr.send(form);
						});
						
					});
					return p2;
				});
			}
			promise = promise.then(function(ret){
				$m.popClose($m.COMP_UPLD.pageId,$m.COMP_UPLD.resultArr);
			});
			return promise;
	};	
	$m.COMP_UPLD.progressBar = function pingpoliCircleProgressBar( ctx , options )
	{
	    this.ctx = ctx;
	    if ( options ) this.options = options;
	    else this.options = {};
	    if ( !this.options.hasOwnProperty("enableBackground") ) this.options.enableBackground = true;
	    if ( !this.options.hasOwnProperty("backgroundColor") ) this.options.backgroundColor = "#555555";
	    if ( !this.options.hasOwnProperty("color") ) this.options.color = "#00ffff";
	    if ( !this.options.hasOwnProperty("radius") ) this.options.radius = 50;
	    if ( !this.options.hasOwnProperty("backgroundLineWidth") ) this.options.backgroundLineWidth = 10;
	    if ( !this.options.hasOwnProperty("lineWidth") ) this.options.lineWidth = 8;
	    if ( !this.options.hasOwnProperty("xPos") ) this.options.xPos = 100;
	    if ( !this.options.hasOwnProperty("yPos") ) this.options.yPos = 100;
	    if ( !this.options.hasOwnProperty("enableRoundLineCaps") ) this.options.enableRoundLineCaps = false;
	    this.percent = 0.0;
	    this.targetPercent = 0.0;
	    this.deltaPercent = 0.0;
	    this.stepSize = 0.0;
	    this.b_animating = false;
	    this.onchange = null;
		this.animateTo = function( percent , seconds )
		{
		    if ( !this.b_animating )
		    {
		        if ( this.targetPercent != percent )
		        {
		            this.targetPercent = percent;
		            this.deltaPercent = (this.targetPercent-this.percent)/seconds;
		            this.stepSize = this.deltaPercent/50;
		            this.b_animating = true;
		            this.step();
		        }
		    }
		};
		this.step = function()
		{
		    this.percent += this.stepSize;
		
		    if ( Math.abs( this.targetPercent - this.percent ) < Math.abs( this.stepSize ) )
		    {
		        this.percent = this.targetPercent;
		        this.b_animating = false;
		    }
		    else 
		    {
		        setTimeout( () => {
		            this.step();
		        } , 20 );
		    }
		
		    if ( this.onchange !== null ) this.onchange();
		};
		this.setPercent = function( percent )
		{
		    this.percent = percent;
		    if ( this.percent < 0 ) this.percent = 0;
		    if ( this.percent > 1 ) this.percent = 1;
		    if ( this.onchange !== null ) this.onchange();
		};
		this.draw = function()
		{
		    if ( this.options.enableBackground )
		    {
		        this.ctx.beginPath();
		        this.ctx.arc( this.options.xPos , this.options.yPos , this.options.radius , Math.PI*3/2 , Math.PI*3/2+Math.PI*2 );
		        this.ctx.strokeStyle = this.options.backgroundColor;
		        this.ctx.lineWidth = this.options.backgroundLineWidth;
		        this.ctx.stroke();
		    }
		    if( this.options.enableRoundLineCaps )
		    {
		        this.ctx.lineCap = 'round';
		    }
		    this.ctx.beginPath();
		    this.ctx.arc( this.options.xPos , this.options.yPos , this.options.radius , Math.PI*3/2 , Math.PI*3/2+this.percent*Math.PI*2 );
		    this.ctx.strokeStyle = this.options.color;
		    this.ctx.lineWidth = this.options.lineWidth;
		    this.ctx.stroke();
		};
	};

	$m.COMP_UPLD.circlePromgressinit = function()
	{
	    var canvas = document.getElementById("canvas");
	    $m.COMP_UPLD.ctx = canvas.getContext( "2d" );
	    $m.COMP_UPLD.circleProgressBar = new $m.COMP_UPLD.progressBar( $m.COMP_UPLD.ctx , {xPos:canvas.width/2,yPos:canvas.height/2,radius:(canvas.width/2-10),backgroundLineWidth:20,lineWidth:16} );
	    $m.COMP_UPLD.circleProgressBar.onchange = () => {
	    	$m.COMP_UPLD.ctx.clearRect( 0 , 0 , canvas.width , canvas.height );
	        $m.COMP_UPLD.circleProgressBar.draw();
	    };
	    $m.COMP_UPLD.circleProgressBar.draw();
	}
</script>
<style>
	input[type="file"]#mfile {
	    position: absolute;
	    width: 0;
	    height: 0;
	    padding: 0;
	    overflow: hidden;
	    border: 0;
	}
	
</style>
</head>
<body>
	<div class="moca_pop_cont_wrap flex fcol" id="Pop_body">
		<!-- 
		<div class="moca_shbox">
			<div class="shbox_inner pb10">
				
			</div>
			<div class="btn_shbox" id="btns" style='display:none'>
				<button type="button" class="button btn_sc" onclick="$m.COMP_UPLD.fn_upload_prev('1')"><i class="fas fa-plus"></i><span>업로드</span></button>
			</div>
		</div>
		 -->
		<label class="btn_fileupload" for="mfile">파일추가</label>
		<input type="file" multiple="multiple" title="파일 추가" id="mfile">
		<span id="white_dim_txt" class="white_dim_txt" style="display:none"></span>
		<canvas id="canvas" class="file_progressbar" width="100%" height="100px" style="touch-action: none; display:none" ></canvas>
		
		<div class="moca_filebox" id="moca_filebox" droppable = "true" ondrop="$m.COMP_UPLD.fn_upload_filedrop(event);" ondragover="$m.COMP_UPLD.fn_upload_filedropover(event);">
			<i class="ico_plus"></i>
			<span>파일을 이곳에 끌어다놓으세요.</span>
		</div>
		<div class="white_dim" style="display:none"></div>
	</div>	
</body>
</html>
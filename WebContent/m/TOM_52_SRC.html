<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" /> 
<meta http-equiv="Pragma" content="no-cache" /> 
<meta http-equiv="Expires" content="Mon, 06 Jan 1990 00:00:01 GMT">
<meta http-equiv="Expires" content="-1" />
<script>
	moca.TOM_52_SRC.___ready = function(args){
		if(moca.getSs("loginInfo") == null || window.history.length < 3 || moca.getSs("certStartTime") == null){
			location.href = '/to';
		};
		moca.setHistory('TOM_52',{'title':'카카오페이인증진행'});
		var re0 = moca.getTimeoutLeftTime(moca.getSs("certStartTime"),6);
		$('.time').html(re0.replace(/시간|분/g,':').replace(/초/g,''));
		moca.TOM_52_SRC.timer_id = setInterval(function(){
			var re = moca.getTimeoutLeftTime(moca.getSs("certStartTime"),6);
			if(re == 'TIMEOUT'){
				clearInterval(moca.TOM_52_SRC.timer_id);
			}else{
				$('.time').html(re.replace(/시간|분/g,':').replace(/초/g,''));
			}
		},1000);
		
		var isYsInfo = moca.getSs("ysInfo");
		if(isYsInfo != null){
			var ysInfo = moca.getSs("ysInfo");
			$('#ys_name').html(ysInfo.ys_name+"(양수인)");
			$('#yd_name').html(ysInfo.yd_name+"(양도인)");
			
			if(moca.getSs("verify_yd_done") == null){
				moca.TOM_52_SRC.yd_done = false;
			}else{
				moca.TOM_52_SRC.yd_done = true;
			}
			if(moca.getSs("verify_ys_done") == null){
				moca.TOM_52_SRC.ys_done = false;
			}else{
				moca.TOM_52_SRC.ys_done = true;
			}
			
			
			if(!moca.TOM_52_SRC.yd_done || !moca.TOM_52_SRC.ys_done){
				moca.TOM_52_SRC.polling_id = setInterval(function(){
					
					moca.TOM_52_SRC.exe({
						url : moca._domain+moca._contextRoot+"/TOM_52/mobile/getKakaoCertStatus.do",
						loadingbar:false,
						data : {
							"header" : moca.header,
							"body" : {
								"tx_id":moca.getSs("response.data.tx_id_ys")+""
								}
						},			
						callback : function(response){
							console.log('ys_poll:',response);
							if(response.error){
								moca.malert(response.error,'');
								return;
							}else if(response.status == "COMPLETE" || response.status == "EXPIRED"){
								$('#ys_status_0').addClass('ok');
								$('#ys_status').html('인증완료');
								//$('#btn_next').html('인증완료');
								//moca.TOM_52_SRC.ys_done = true;
								
								if(moca.TOM_52_SRC.yd_done && moca.TOM_52_SRC.ys_done){
									clearInterval(moca.TOM_52_SRC.polling_id);
									$('#btn_next').html('인증완료');
									$('.btn_go').attr('disabled',false);
									$('#step0').html('카카오톡을 통한 인증이<br>완료되었습니다.');
									$('#step1').html('');
									$('#step2>span').html('');
									clearInterval(moca.TOM_52_SRC.timer_id);
								}
								
								if(moca.TOM_52_SRC.ys_done){
								}else{
									moca.TOM_52_SRC.verify(moca.getSs("response.data.tx_id_ys"),'verify_ys_done');
								}
							}
							
							
							
							
							
							
							
							
							
							
							
							moca.TOM_52_SRC.exe({
								url : moca._domain+moca._contextRoot+"/TOM_52/mobile/getKakaoCertStatus.do",
								loadingbar:false,
								data : {
									"header" : moca.header,
									"body" : {
										"tx_id":moca.getSs("response.data.tx_id_yd") +""
										}
								},			
								callback : function(response){
									console.log('yd_poll2:',response);
									if(response.error){
										moca.malert(response.error,'');
										return;
									}else if(response.status == "COMPLETE" || response.status == "EXPIRED"){
										$('#yd_status_0').addClass('ok');
										$('#yd_status').html('인증완료');
										//$('#btn_next').html('인증완료');
										//moca.TOM_52_SRC.yd_done = true;
										
										if(moca.TOM_52_SRC.yd_done && moca.TOM_52_SRC.ys_done){
											clearInterval(moca.TOM_52_SRC.polling_id);
											$('#btn_next').attr('disabled',false);
											$('#btn_next').html('인증완료');
											$('.btn_go').attr('disabled',false);
										}
										
										
										if(moca.TOM_52_SRC.yd_done){
										}else{
											moca.TOM_52_SRC.verify(moca.getSs("response.data.tx_id_yd"),'verify_yd_done');
										}									
									}
								}
							});
						}
					});
				},5000);
			
			
			
			}//if(moca.TOM_52_SRC.yd_done || moca.TOM_52_SRC.ys_done){
			else{
				$('#yd_status_0').addClass('ok');
				$('#yd_status').html('인증완료');
				
				$('#ys_status_0').addClass('ok');
				$('#ys_status').html('인증완료');
				
				$('#btn_next').attr('disabled',false);
				$('#btn_next').html('인증완료');
				$('.btn_go').attr('disabled',false);
				
				$('#step0').html('카카오톡을 통한 인증이<br>완료되었습니다.');
				
				$('#step1').html('');
				$('#step2>span').html('');
				clearInterval(moca.TOM_52_SRC.timer_id);
				
			}
		}
	};
	var sellerVerifyYn = 'N';	// 양도인 검증완료여부
	var buyerVerifyYn = 'N';	// 양수인 검증완료여부
	moca.TOM_52_SRC.verify = function(tx_id,_key){
		var inqType = '';
		if('verify_ys_done' == _key){
			inqType = "2";
		}else{
			inqType = "1";		
		}
		

		
		// 호출 시에는 데이터 세션에 set하지 않음. 둘 중 어떤게 먼저 서명완료될지 모르므로, 호출 시 양도면 양수인정보, 양수면 양도안정보를 세션에서 조회
		var sessKey = _key == "verify_ys_done"? "verify_yd_done" : "verify_ys_done";
		
		var veryfyResData = moca.getSs(sessKey);
		
		if(veryfyResData != null && veryfyResData != undefined){
			if(veryfyResData.error == null){
				sellerVerifyYn = veryfyResData.result.sellerVerifyYn;
				buyerVerifyYn = veryfyResData.result.buyerVerifyYn;
			}
		}
		moca.TOM_52_SRC.exe({
			url : moca._domain+moca._contextRoot+"/TOM_52/mobile/sendKakaoCertVerify.do",
			loadingbar:false,
			data : {
				"header" : moca.header,
				"body" : {
					// 1: 양도인, 2: 양수인
					"tx_id":tx_id+"",
					"CertificationId":tx_id+"",
					"inqType" : inqType,
					"idx": moca.getSs('transferownerId'),
					"sellerVerifyYn" : sellerVerifyYn,
					"buyerVerifyYn" : buyerVerifyYn
					}
			},			
			callback : function(response){
				var veryfyResData = response;
				if(veryfyResData.error == null){
					if(sellerVerifyYn != 'Y'){
						sellerVerifyYn = veryfyResData.result.sellerVerifyYn;
					}
					if(buyerVerifyYn != 'Y'){
						buyerVerifyYn = veryfyResData.result.buyerVerifyYn;
					}		
				}
				moca.setAs(_key,response);
				if('verify_ys_done' == _key){
					moca.TOM_52_SRC.ys_done = true;
				}else{
					moca.TOM_52_SRC.yd_done = true;
				}
			}
		});
		
	};

	function fn_next(){
		if(moca.TOM_52_SRC.ys_done && moca.TOM_52_SRC.yd_done && $('#btn_next').html() == '인증완료'){
			location.href = 'TOM_61.html';
		}
	};
	
	
	moca.TOM_52_SRC.toCancel = function(){
		moca.mconfirm('소유권이전을 취소하시겠습니까?','',function(_result){
			if(_result == 'Y'){
				moca.TOM_52_SRC.exe({
					url : moca._domain+moca._contextRoot+"/TOM_60/mobile/cancelTransferOwner.do",
		            data : {
		            	"header" : moca.header,
		            	"body" : {
		            		Stage:"26",
		            		idx:moca.getSs("transferownerId")+""
		            	}
		            },		
					callback : function(response){
						
						if(response.error){
							moca.merror(response.error,'',function(){
								location.href='TOM_25.html?isCancel=true';
							});
						}else if(response.rePayResYn == 'N'){
			        	    moca.mresult('성공적으로 취소되었습니다!','',function(){
			        		   location.href='TOM_25.html?isCancel=true';
			        	   });	
						}else{
							//polling후
			        	    moca.mresult('성공적으로 취소되었습니다!','',function(){
			        	    	location.href='TOM_25.html?isCancel=true';
			        	    });	
						}

					}
				});
				
			}
		});
	};
</script>
</head>
<body>
	<div class="wrap">
		<header class="titlebar">
			<h2 class="tit"><a href="javascript:void(0)" onclick="moca.TOM_52_SRC.toCancel()">이전 취소</a></h2>
		</header>

		<div class="content btn_cont fx2 jct2">
			<div class="top_txt">
				<p id="step0">카카오톡 알림을 통하여<br>인증을 진행합니다.</p>
			</div>
			<div class="c_form">
				<p class="tac" id="step1">아래 남은 시간 내에 인증을 진행하지<br>않을 시 자동 취소됩니다.</p>
				<div class="ly">
					<div class="sc">
						<span class="character1"></span><span class="name" id="ys_name">홍길동(양수인)</span>
						<div class="prog" id="ys_status_0">
							<span class="ing"  id="ys_status">인증중…</span><span class="load"></span>
						</div>
					</div>
					<div class="cen" id="step2"><!-- <span>3일</span> --><span class="time">23:58</span></div>
					<div class="sc">
						<span class="character2"></span><span class="name" id="yd_name">김말순(양도인)</span>
						<div class="prog" id="yd_status_0">
							<span class="ing" id="yd_status">인증중…</span><span class="load"></span>
						</div>
					</div>
				</div>	
			</div>
			<div class="infobox">
				<div class="dfbox">
					<h3>안내사항</h3>
				</div>
				<ul>
					<li>인증은 거래 여부를 확인 하기 위함이며 인증만으로 소유권 이전이 되지 않습니다.</li>
					<li>오후 5시 이후 비용 결제 시에는 익일(영업일) 9시에 소유권 이전 등록을 진행합니다.</li>
				</ul>
			</div>
		</div>
		<div class="btn_btm">
			<button id="btn_next" class="btn_go" type="button"  onclick='fn_next(this)' disabled>인증 중…</button>
		</div>
	</div>
	
</body>
</html>
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" /> 
<meta http-equiv="Pragma" content="no-cache" /> 
<meta http-equiv="Expires" content="Mon, 06 Jan 1990 00:00:01 GMT">
<meta http-equiv="Expires" content="-1" />
<meta name="viewport"
	content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>모바일 웹 온라인 소유권 이전</title>
<link rel="stylesheet" type="text/css" href="../css/mobile.css">
<script>
	moca.TOM_80_SRC.___ready = function(args){
		if(moca.getSs("loginInfo") == null || window.history.length < 3){
			location.href = '/to';
		};
		moca.setHistory('TOM_80',{'title':'계좌등록전화인증','time':(new Date()).getTime()});
		
		var arsResmap = moca.getSs("arsResmap");
		if(arsResmap != null){
			$('.btn_go').html('다음');
		}
		
		var userPayInfo = moca.getSs("userPayInfo");
		if(moca.getSs("loginInfo") != null && (moca.getSs("loginInfo").name.indexOf('김세창') > -1 || moca.getSs("loginInfo").name.indexOf('성혜진') > -1)){
			userPayInfo.birthday = '19831130';
		}
		
		
		/*
		else if(moca.getSs("loginInfo") != null 
				&& (moca.getSs("loginInfo").name.indexOf('이지선') > -1 || moca.getSs("loginInfo").name.indexOf('박민성') > -1)){
			userPayInfo.birthday = '19831130';
		}
		*/
		
		var verifyResMap = moca.getSs("verifyResMap");
		
		$("#phoneno").html(userPayInfo.phoneno);
		$("#auth_numb").html(verifyResMap.auth_numb);
	};

	function go(){
		
		var userPayInfo = moca.getSs("userPayInfo");
		if(moca.getSs("loginInfo") != null && (moca.getSs("loginInfo").name.indexOf('김세창') > -1 || moca.getSs("loginInfo").name.indexOf('성혜진') > -1)){
			userPayInfo.birthday = '19831130';
		}
		/*
		else if(moca.getSs("loginInfo") != null 
				&& (moca.getSs("loginInfo").name.indexOf('이지선') > -1 || moca.getSs("loginInfo").name.indexOf('박민성') > -1)){
			userPayInfo.birthday = '19831130';
		}
		*/
		
		var verifyResMap = moca.getSs("verifyResMap");
		
		if($('.btn_go').html() == '다음'){

			
			
			//출금계좌등록하러가자(요청)
			moca.TOM_80_SRC.exe({
	    		url : moca._domain+moca._contextRoot+"/TOM_79/mobile/savePaymentAccount.do",
	    		loadingbar:true,
	    		loadingInfo:{type:"mobile",className:"_modal",content:"<span>잠시만 기다려주세요!</span>"},
	            data : {
	            	"header" : moca.header,
	            	"body" : {
	            		"bankOwner":moca.getSs("bankOwner"),// 
	            		"bankNm":moca.getSs("BankNm"),	// 
	            		"bankCd":moca.getSs("BankCd"),		// 
	            		"accountNo":moca.getSs("acct_no"),		//
	            		"birthday":userPayInfo.birthday,			// 
	            		"Pay_Password":moca.getSs("Pay_Password_Re"),		// 결제비번
	            		"traceNo":userPayInfo.trace_no 
	            	}
	            },			
	    		callback : function(response){
	    			if(response.resMap.reply == "0000"){
	    				// 출금이제 계좌등록 전문 응답 조회
	    				getSaveAcntRes(response.resMap);
	    			}
	    		}
	    	});		
		} else {
			//전화가옵니다.
			moca.TOM_80_SRC.exe({
	    		url : moca._domain+moca._contextRoot+"/TOM_79/mobile/reqArsCall.do",
	    		loadingbar:true,
	    		loadingInfo:{type:"mobile",className:"_modal",content:"<span>잠시만 기다려주세요!</span>"},
	            data : {
	            	"header" : moca.header,
	            	"body" : {
	            		"phoneno": userPayInfo.phoneno,	
	            		"birthday": userPayInfo.birthday,	
	            		"custnm": userPayInfo.custnm,	
	            		"nation": userPayInfo.nation,	
	            		"gender": userPayInfo.gender,	
	            		"telecd": userPayInfo.telecd,	
	            		"banknm": sessionStorage.getItem("BankNm"),	
	            		"acctno": sessionStorage.getItem("acct_no"),
	            		"traceNo": userPayInfo.trace_no,
	            		"auth_numb": verifyResMap.auth_numb
	            	}
	            },			
	    		callback : function(response){
					/*
					arsResmap : {
					reply	4	응답코드	0000 - 정상
					reply_msg	50	응답 메시지	
					record	*	녹취내용	
					trace_no	12	처리일련번호	
	    		}
					*/
	    			if(response.arsResmap.reply == "0000"){
	    				moca.setAs("arsResmap",response.arsResmap);
	    				var userPayInfo = JSON.parse(sessionStorage.getItem("userPayInfo"));
	    				userPayInfo.trace_no = response.arsResmap.trace_no;
	    				moca.setAs("userPayInfo",userPayInfo);
	    				
	    				$('.btn_go').html("다음");
	    			}
	    		}
	    	});		
		}
	};
	
	// 출금이제 계좌등록 전문 응답 조회
	function getSaveAcntRes(obj){
		moca.TOM_80_SRC.polling_id = setInterval(function(){
			//출금이제 계좌등록 전문 응답 조회
			moca.TOM_80_SRC.exe({
	    		url : moca._domain+moca._contextRoot+"/TOM_79/mobile/savePaymentAccountRes.do",
	    		loadingbar:true,
	    		loadingInfo:{type:"mobile",className:"_modal",content:"<span>잠시만 기다려주세요!</span>"},
	            data : {
	            	"header" : moca.header,
	            	"body" : {
	            		"bankCd":obj.bankCd,
	            		"birthday":obj.birthday,
	            		"bankNm":obj.bankNm,
	            		"accountNo":obj.accountNo,
	            		"bankOwner":obj.bankOwner,
	            		"Pay_Password": obj.Pay_Password,
	            		"reqDt":obj.reqDt,
	            		"seqNo":obj.seqNo,
	            		"traceNo":obj.traceNo
	            	}
	            },			
	    		callback : function(response){
	    			if(response.rcvFlag == "Y"){
	    				clearInterval(moca.TOM_80_SRC.polling_id);
	    				if(response.resCd == '0000'){
	    					location.href = 'TOM_81.html';
	    				}else if(response.resCd == 'U235'){
	    					moca.malert("["+response.resCd+"]"+"실명번호 불일치","",function(){
	    						location.href = 'TOM_75.html';
	    					});
	    				}else{
	    					moca.malert("[Y:"+response.resCd+"]"+response.resMsg);
	    					return;
	    				}
	    			}else if(response.rcvFlag == "F" || response.rcvFlag == "T"){
	    				clearInterval(moca.TOM_80_SRC.polling_id);
	    				moca.malert("["+response.rcvFlag+"]"+response.error,"",function(){
    						location.href = 'TOM_75.html';
    					});
	    				return;
	    			}else{
	    				clearInterval(moca.TOM_80_SRC.polling_id);
	    				if(response.error == 'Cannot invoke "com.carbang365.ToUserVO.getIdx()" because "userVo" is null'){
	    					moca.merror("세션이 끊어졌습니다.","다시로그인하세요.",function(){
	    						location.href = '/to';
	    					});
	    				}
	    			}
	    		}
	    	});	
		},2000);
	};
	moca.TOM_80_SRC.toCancel = function(){
		moca.mconfirm('소유권이전을 취소하시겠습니까?','',function(_result){
			if(_result == 'Y'){
				moca.TOM_80_SRC.exe({
					url : moca._domain+moca._contextRoot+"/TOM_60/mobile/cancelTransferOwner.do",
		            data : {
		            	"header" : moca.header,
		            	"body" : {
		            		Stage:"26",
		            		idx:moca.getSs("transferownerId")+""
		            	}
		            },		
					callback : function(response){
						
						if(response.error){
							moca.merror(response.error,'',function(){
								location.href='TOM_25.html?isCancel=true';
							});
						}else if(response.rePayResYn == 'N'){
			        	    moca.mresult('성공적으로 취소되었습니다!','',function(){
			        		   location.href='TOM_25.html?isCancel=true';
			        	   });	
						}else{
							//polling후
			        	    moca.mresult('성공적으로 취소되었습니다!','',function(){
			        	    	location.href='TOM_25.html?isCancel=true';
			        	    });	
						}

					}
				});
			}
		});
	};
	
	moca.TOM_80_SRC.back = function(){
		location.href = 'TOM_75.html';
	};
</script>
</head>
<body>
	<div class="wrap">
		<header class="titlebar">
			<button class="btn_back" type="button" onclick="moca.TOM_80_SRC.back()">이전페이지</button>
			<h2 class="tit"><a href="javascript:void(0)" onclick="moca.TOM_80_SRC.toCancel()">이전 취소</a></h2>
		</header>

		<div class="content btn_cont fx2 jct2">
			<div class="top_txt">
				<p>전화 후 <span>인증번호</span>를<br>입력해주세요.</p>
			</div>
			<ul class="d_form2">
				<li>
					<label>입력숫자</label>
					<strong class="tbx2" id="auth_numb"></strong>					
				</li>
				<li>
					<label>휴대폰번호</label>	
					<div class="ff">
						<span class="tbx2" id="phoneno">01022843746</span>
<!-- 						<div class="rta">
							<span class="tbx">휴대폰 번호가 변경되었나요?</span>
							<button class="btn_in" type="button">변경하기</button>
						</div> -->
					</div>	
				</li>
				<li>
					<label>인증방법 안내</label>
					<div class="infobox">
						<ul>
							<li>하단의 전화받기 버튼을 클릭하세요.</li>
							<li>ARS 청취 후 상단의 <span class="txt_blue">입력숫자 4자리</span>를 입력하세요.</li>
							<li>통화종료 후 다음 버튼을 클릭하여 인증을 완료하세요.</li>
						</ul>
					</div>
				</li>
				
			</ul>
		</div>
		<div class="btn_btm">
			<button class="btn_go" type="button" onclick="go()">전화받기</button>
		</div>

	</div>
</body>
</html>
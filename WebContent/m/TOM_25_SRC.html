<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" /> 
<meta http-equiv="Pragma" content="no-cache" /> 
<meta http-equiv="Expires" content="Mon, 06 Jan 1990 00:00:01 GMT">
<meta http-equiv="Expires" content="-1" />
<title>모바일 웹 온라인 소유권 이전</title>
<script>
	moca.TOM_25_SRC.___ready = function(args){
		
		$("._modal").hide();	
		
		$('#CAR_NUM').focus();
		moca.mbl_showKeyPad();
		
		
		var pro1 = Promise.resolve();
			pro1 = pro1.then(function(){
				var pro2 = Promise.resolve();
				if(window.BRIDGE != null && moca.getSs("loginInfo") == null){
					pro2 = pro2.then(function(){
						var deviceData = BRIDGE.getStateUsim();
						var arr1 = deviceData.split("___");
						
						var fcmToken = "";
						var deviceID = "";
						var socialID = "";
						var email = "";
						var type = "";
						
						fcmToken = arr1[3];
						deviceID = arr1[4];
						socialID = arr1[5];
						email	 = arr1[6];
						type	= arr1[7];
						
						var loginTemp0 = {};
						loginTemp0.id = socialID;
						loginTemp0.email = email;
						sessionStorage.setItem('loginTemp0', JSON.stringify(loginTemp0));
						sessionStorage.setItem('inqType', "1");					
						sessionStorage.setItem('FCMToken', fcmToken);
						sessionStorage.setItem('DeviceID', deviceID);
						sessionStorage.setItem('loginType', type);
					});
					pro2 = pro2.then(function(){
						return new Promise(function(resolve,reject){
			    	    	moca.TOM_25_SRC.exe({
			    	    		url : moca._domain+moca._contextRoot+"/TOM_02/userInfo.do",
			    	    		loadingbar:true,
			    	            data : {
			    	            	"header" : moca.header,
			    	            	"body" : {"id":JSON.parse(sessionStorage.getItem('loginTemp0')).id+"",
			    	            		"loginType":sessionStorage.getItem('loginType')
			    	            		}
			    	            },			
			    	    		callback : function(response){
			    	    			resolve(response);
			    	    		}
			    	    	});
						});
					});
					pro2 = pro2.then(function(response){
    	    			if(response.userInfo != null){
    	    				//모바일 로그인용 id, type 정보 
    	    				try{
	    	    				if(typeof(BRIDGE) != "undefined" ){
	    	    					BRIDGE.saveLoginInfo(JSON.parse(sessionStorage.getItem('loginTemp0')).id+"",sessionStorage.getItem('loginType')+"");
	    	    				}
	    	    				moca.setSs('loginInfo',response.userInfo);
    	    				}catch(e){
    	    					alert(e);
    	    				}
    	    			}else{
    	    				moca.merror("사용자정보가져오기오류",JSON.parse(sessionStorage.getItem('loginTemp0')).id+"/"+sessionStorage.getItem('loginType')+"/"+JSON.parse(sessionStorage.getItem('loginTemp0')).email+"/"+JSON.parse(sessionStorage.getItem('loginTemp2')).name);
    	    			}
					});
					
				}else{
					pro2 = pro2.then(function(){
						if(moca.getSs("loginInfo") == null){
							location.href = '/to';
						};
					});
				}
				pro2 = pro2.then(function(){
					var isCancel = moca.getParameter("isCancel");
					if(isCancel == 'true'){
						var notViewToday = localStorage.get("notViewToday");
						localStorage.clear();
						localStorage.set("notViewToday",notViewToday);
					}
				});
				return pro2;
			});

			if((moca.getLs('notViewToday')+'').substring(0,8) != moca.now().substr(0,8)){
				pro1 = pro1.then(function(){
					return new Promise(function(resolve,reject){
						moca.TOM_25_SRC.exe({
							url : moca._domain+moca._contextRoot+"/TOM_01/selectGonggis.do",
							loadingbar:false,
							data : {
								"header" : moca.header,
								"body" : {
								}
							},			
							callback : function(response){
								resolve(response);
							}
						});
					});
				});
				pro1 = pro1.then(function(response){
					if(response.list != null && response.list.length > 0){
						return new Promise(function(resolve,reject){
							moca.mpopup("공지사항",'',function(){
								resolve();
							},location.origin+"/to/m/TOM_01.html");	
						});
					};
				});						
			}
			pro1 = pro1.then(function(){
				//진행스텝확인
		 		var stepObj = moca.getStep();
				if(moca.trim(stepObj.moveStep) != ""){
					moca.mconfirm("<b>진행중인단계가있습니다.</b>","> "+stepObj.moveTitle,function(result){
						if(result == 'Y'){
							location.href = stepObj.moveStep;
						}else{
							localStorage.clear();
						}
					},'처음부터','진행단계로이동');
				}	
			});
			pro1 = pro1.catch(function(rv){
				return rv;
			});
			return pro1;
			
			
		
	};
	
	moca.TOM_25_SRC.logout = function(){
		moca.mconfirm('로그아웃하시겠습니까?','',function(result){
			if(result == 'Y'){
				var loginType = moca.getSs("loginType");
				if(loginType ==  '1'){
					Kakao.init(config.getSocailLoginKakaoKey());
					Kakao.Auth.logout(function(response) {
						moca.clearAs();
						if(window.BRIDGE != null){
							BRIDGE.logout();
						}else{
							location.href = config.getSocailLoginUrl();
						}
					}); 
				}else if(loginType ==  '2'){
					if(window.BRIDGE != null){
						BRIDGE.logout();
					}else{
						location.href = config.getSocailLoginUrl();
					}
					
				}else if(loginType ==  '3'){
					if(window.BRIDGE != null){
						BRIDGE.logout();
					}else{
						(function(d, s, id){
							var js, fjs = d.getElementsByTagName(s)[0];
							if (d.getElementById(id)) {return;}
							js = d.createElement(s); js.id = id;
							js.src ="//connect.facebook.com/ko_KR/sdk.js";
							fjs.parentNode.insertBefore(js, fjs);
						}(document,'script','facebook-jssdk'));
						window.fbAsyncInit= function() {
						    FB.init({
						      appId      : config.getSocailLoginFacebookKey(),
						      status     : true,
						      cookie     : true,
						      xfbml      : true,
						      version    : 'v10.0'
						    });
					        FB.getLoginStatus(function(response) {
			                    if (response && response.authResponse) {
			                        var token= response.authResponse.accessToken;
			                        var userId= response.authResponse.userID;
			                        var name= response.authResponse.name;
			                    }
								FB.logout(function(response) {
									moca.clearAs();
									location.href = config.getSocailLoginUrl();
								});
					        });
						};
					}
				}else{
					moca.clearAs();
					if(window.BRIDGE != null){
						BRIDGE.logout();
					}else{
						location.href = config.getSocailLoginUrl();
					}
				}
			}
		});
	};
	

	function open_modal() {
		$(".process").show();
	};
			
	
	function close_modal() {
		$("._modal").hide();
	};
	
	
	
	function fnNext(thisObj){
		if(moca.trim($('#CAR_NUM').val()) == ''){
			moca.malert('차량번호를 입력하세요.','',function(){
				$('#CAR_NUM').focus();
			});
			return;
		} 
		if(moca.trim($('#OWNER_NAME').val()) == ''){
			moca.malert('이름을 입력하세요.','',function(){
				$('#OWNER_NAME').focus();
			});
			return;		
		} 
		moca.TOM_25_SRC.loading_id = moca.loading(null,null,null,{type:"mobile",className:"_modal",content:"<strong>제원정보를 분석하는 중…</strong> <span>잠시만 기다려주세요!<br>차량 분석에 약 30초~1분이 소요됩니다.<br>분석 후 페이지가 전환됩니다.</span>"});
		moca.TOM_25_SRC.exe({
			url : moca._domain+moca._contextRoot+"/TOM_25/mobile/sendCoocon.do",
			data : {
				"header" : moca.header,
				"body" : {
					"CAR_NUM":$('#CAR_NUM').val().replace(/\s/g,'')+"",
					"OWNER_NAME":$('#OWNER_NAME').val()+""
					}
			},			
			callback : function(response){
				if(response.error !=null){
					moca.merror(response.error,"",function(){
						if(response.error == '로그인안됨'){
							location.href = 'TOM_02.html';
						}
					});	
				}
				if(response != null && response.statusCd != '00000000'){
					moca.loading(moca.TOM_25_SRC.loading_id,0,null);
					if(response.statusMsg != null){
						//var arr = response.statusMsg.split('.');
						var arr = response.statusMsg.split('^^');
						var m2 = '';
						if(arr.length == 1){
							m2 = null;
						}else{
							m2 = arr[1];		
						}
												
						
						
						//현재시간계산
						let today = new Date();
						let hours = today.getHours();						
						let time_check = "";
																	
						//운영시간 불러오기
						moca.TOM_25_SRC.exe({
				    		url : moca._domain+moca._contextRoot+"/TOM_39/selecIsTimeOnForTORequest.do",
				            data : {
				            	"header" : moca.header,
				            	"body" : {
				            	}
				            },			
				    		callback : function(response){
				    			if(response.error != null){
				    				moca.error(response.error,"",function(){				    					
				    				});
				    				return;
				    			}
				    			if(response.mapTimeCheck != null){
				    				if(response.mapTimeCheck.IsTimeOn != '1'){
				    					time_check = "N";
				    				}
				    			}
				    			
				    		}
				    	});
						
						
						
						
						
						
						if(response.statusCd == "8000F102" || response.statusCd == "8000C508") {
							$(".alert_name").show();
						}
/* 						else if(hours>=22 || hours<=7){
							$(".alert_time").show();
						} */
						else if(time_check == "N"){
							$(".alert_time").show();
						}	
						else {
							$(".alert_error").show();
						}

						
						
/* 						moca.merrorBig("<span>중고차 분석</span>을<br>실패했습니다.",arr[0].replace(/\./g,'<br>'),"["+response.statusCd+"]","확인",function(){
							$('#CAR_NUM').focus();
						}); */
						
						
						return;
					}else{
						var arr = response.statusMsg.split('^^');
						moca.merrorBig("<span>중고차 분석</span>을<br>실패했습니다.",arr[0].replace(/\./g,'<br>'),"["+response.statusCd+"]","확인",function(){
							$('#CAR_NUM').focus();
						});		
						return;	
					}
				}else{
					if(response.REGNO != null){
						var arr = response.REGNO.split('-');
						moca.setSs("coocon_data_REGNO1",arr[0]);
						moca.setLs("coocon_data_REGNO1",arr[0]);
						if(arr.length > 1){
							moca.setSs("coocon_data_REGNO2",arr[1].replace(/\*/g,''));
							moca.setLs("coocon_data_REGNO2",arr[1].replace(/\*/g,''));
						}
					}
					moca.setSs("coocon_data",response.idx);
					moca.setSs("coocon_data_LAST_OWNER",response.LAST_OWNER);
					moca.setLs("coocon_data",response.idx);
					moca.setLs("coocon_data_LAST_OWNER",response.LAST_OWNER);
					
					moca.setSs("ecoYN",response.ecoYN);
					moca.setLs("ecoYN",response.ecoYN);
					
					moca.TOM_25_SRC.exe({
						url : moca._domain+moca._contextRoot+"/TOM_39/mobile/carInfoDetail.do",
						//loadingbar:true,
						//loadingInfo:{type:"mobile",className:"_modal",content:"<span>잠시만 기다려주세요!</span>"},
						data : {
							"header" : moca.header,
							"body" : {
								//"idx":_idx+""
								//"idx":"46"//근저당 압류/촉탁 "57" :저당연락처 37:구조변경 21:용도변경 102:영업용화물
								"idx":response.idx+""
								}
						},			
						callback : function(response){
							moca.setSs("TOM_39_response",response);
							location.href = 'TOM_39.html';
						}
					});
				}
			}
		});
	};
	
	
	
</script>
</head>
<body>
	<div class="wrap">
		<header class="titlebar">
			<h2 class="tit"><a href="javascript:void(0)" onclick="moca.TOM_25_SRC.logout()">로그아웃</a></h2>
			</header>
		<div class="inner">
			<div class="top_txt">
				<p><span>차량번호/소유자명</span><br>입력하세요.</p>
			</div>
		</div>

		<div class="content btn_cont fx2">
			<div class="inner">
				<ul class="d_form type2">
					<li>
						<div class="gox3 f2">
							<input id="CAR_NUM" class="input_frm2" type="text" placeholder="차량번호" value="42구0213">	
							<button class="btn_clear" type="button" onclick="moca.compClear(this)">삭제</button>
							<p class="tip-type2">차량번호를 입력해주세요.</p>
						</div>

					</li>
					<li>
						<div class="gox3 f2">
							<input id="OWNER_NAME" class="input_frm2" type="text" placeholder="소유자명" value="박민성">	
							<button class="btn_clear" type="button" onclick="moca.compClear(this)">삭제</button>
							<p class="tip-type2">소유자명을 입력해주세요.</p>
						</div>

					</li>
				</ul>
				<div class="btn_btm">
					<button class="btn_go" type="button" onclick="fnNext()">다음</button>
				</div>
				<div class="transfer-tip">
					<button onclick="open_modal()">이전진행 절차보기</button>
				</div>
			</div>
		</div>
	</div>
	<div class="_modal process">
		<div class="pop_msg type4 fm">
			<div class="modal_inner">
				<div class="top_txt modal">
					<p>
						<span>소유권 이전<br>진행절차</span> 확인하세요.
					</p>
				</div>
			</div>
			
			<div class="content btn_cont fx2 jct2">
				<div class="modal_inner">
					<ol class="step mt10">				
						<li>
							<div class="num">
								<em>1</em>
								<span>step</span>
							</div>
							<span class="ti">차량분석</span>
							<span>이전 차량 분석하세요.</span>
						</li>
						<li>
							<div class="num">
								<em>2</em>
								<span>step</span>
							</div>
							<span class="ti">이전정보입력 및 인증</span>
							<span>정보 입력 후 인증해주세요.</span>
						</li>
						<li>
							<div class="num">
								<em>3</em>
								<span>step</span>
							</div>
							<span class="ti">비용결제</span>
							<span>비용 확인 후 결제를 완료하세요.</span>
						</li>
						<li>
							<div class="num">
								<em>4</em>
								<span>step</span>
							</div>
							<span class="ti">소유권이전 신청</span>
							<span>관공서에 이전신청을 진행합니다.</span>
						</li>
						<li>
							<div class="num">
								<em>5</em>
								<span>step</span>
							</div>
							<span class="ti">소유권 이전등록 완료</span>
							<span>해당 관공서를 통한 이전이 완료됩니다.</span>
						</li>
					</ol>
					<p class="tip">양수인의 이전비용 입금 완료한 시간이 오후 4시 이후인 경우에는 이전 예약 대기로 익일(영업일) 9시에 소유권 이전을 진행합니다.</p>
					<button class="btn_close" type="button" onclick="close_modal()">확인</button>
				</div>
			</div>
		</div>
	</div>
	
	<div class="_modal alert_name">
		<div class="pop_msg type1">
			<div class="pop_cont">
				<strong>소유자 성명이 일치하지 않습니다.</strong>
				<span>확인 후 거래하시기 바랍니다.</span>
			</div>
			<div class="btnbox">
				<div class="rta">
					<button class="btn_cm" type="button" onclick="close_modal()">확인</button>
				</div>
			</div>
		</div>
	</div>
	
		<div class="_modal alert_error">
		<div class="pop_msg type1">
			<div class="pop_cont">
				<strong>자동차등록원부 발급 오류</strong>
				<span>자동차민원 대국민포털(ecar.go.kr) 서버 장애로 자동차등록원부 발급에 실패했습니다. 장애복구 완료 후 다시 분석해주세요.</span>
			</div>
			<div class="btnbox">
				<div class="rta">
					<button class="btn_cm" type="button" onclick="close_modal()">확인</button>
				</div>
			</div>
		</div>
	</div>
	
	<div class="_modal alert_time">
		<div class="pop_msg type1">
			<div class="pop_cont">
				<strong>시스템 정비 안내</strong>
				<span>22:00~07:00까지는 시스템정비작업으로 인해 신청할 수 없습니다. 07시 이후 다시 신청해주세요.</span>
			</div>
			<div class="btnbox">
				<div class="rta">
					<button class="btn_cm" type="button" onclick="close_modal()">확인</button>
				</div>
			</div>
		</div>
	</div>
	

</body>
</html>